{% extends "../inc/experiment_base.html" %}


{#{% block bodyClass %} sidebar-xs {% endblock %}#}

{% block sidebar2 %}
    {% include "../inc/article_side.html" %}
{% endblock %}

{% block pageAction %}
    <div class="btn-group">
        <button {% if model|length> 1 %} data-toggle="dropdown" {% endif %}
                {% if allow == 0 %}disabled{% endif %}
                class="btn btn-default btn-primary document_add dropdown-toggle
                {% if allow == 0 or controller.get('cate_id') == null %}disabled{% endif %}"
                {% if model|length == 1 %} url="/admin/article/add?model_id={{ modellist[0].id }}&pid={{ pid }}&cate_id={{ cate_id }}&group_id={{ group_id }}&sortid={{ sortid }}"{% endif %}>
            <i class="icon-plus-circle2 position-left"></i>
            添加内容
            {% if model|length > 1 %}<span class="caret"></span>{% endif %}
        </button>
        {% if model|length > 1 %}
            <ul class="dropdown-menu">
                {% for val in modellist %}
                    <li>
                    <li>
                        <a href="/admin/article/add?model_id={{ val.id }}&pid={{ pid }}&cate_id={{ cate_id }}&group_id={{ group_id }}&sortid={{ sortid }}"
                           class="">添加{{ val.title }}</a></li>
                {% endfor %}

            </ul>
        {% endif %}
    </div>
{% endblock %}

{% block breadcrumb %}
    <ul class="breadcrumb position-right">
        <li>
            <a href="#">首页</a>
        </li>
        <li>
            <a href="/admin/article/index">实验内容</a>
        </li>
        {% for nav in breadcrumb %} {% if cate_id == nav.id %}
            <li class="active">
                {{ nav.title }}
                <span class="badge badge-primary">{{ _total }}</span>
                {% if allow == 0 %}
                    <span class="label label-flat border-warning text-warning-600 ml-20"><i
                                class="icon-warning position-left"></i>该类别下不允许发布内容</span>
                {% endif %}
            </li>
        {% else %}
            <li><a href="/admin/article/index?cate_id={{ nav.id }}">
                    {{ nav.title }}</a>
            </li>
        {% endif %} {% endfor %} {% if article.id >0 %}
            <li> <i class="fa fa-list-ul"></i> {{ article.title }} </li>{% endif %}
    </ul>
{% endblock %}


{% block content %}
    <div class="panel panel-flat">
        {% if sort %}
            <div class="tabbable tab-content-bordered ">
                <ul class="nav nav-tabs nav-tabs-bottom">
                    {% for val in sort.types %}
                        <li class="{% if controller.get('sortid')|length > 0 %}{% if controller.get('sortid')==val.enable %}active{% endif %}{% else %}{% if sort.defaultshow == val.enable %}active{% endif %}{% endif %}">
                            <a href="/admin/article/index?pid={{ pid }}&cate_id={{ cate_id }}&group_id={{ group_id }}&sortid={{ val.enable }}"> {{ val.name }}</a>
                        </li>
                    {% endfor %}
                </ul>

            </div>
            <div class="panel-body " id="sortbody" style="padding: 0">
                <div class="tab-content">
                    <table class="table table-hover">
                        <tbody>
                        {%for val in typevar%}
                            {%if val.search >= 1 and val.available==1%}
                                <tr>
                                    <td style="width: 140px" class="text-right">
                                        {{val.option.title}}:
                                    </td>
                                    <td>
                                        {%if 0 == nsobj[val.option.identifier] or null == nsobj[val.option.identifier]%}
                                            <span style="margin-right: 10px">全部</span>
                                        {%else%}
                                            <a href="/admin/article/index?pid={{pid}}&cate_id={{cate_id}}&group_id={{group_id}}&sortid={{sortid}}&sortval={{0|sort_url(val.option.identifier,typevar,nsobj)}}" class="text-primary" style="margin-right: 10px">全部</a>
                                        {%endif%}
                                        {%for v in val.rules %}
                                            {%if v.id|sort_act(nsobj[val.option.identifier])%}
                                                <span style="margin-right: 10px">{{v.name}}{{val.option.unit}}</span>
                                            {%else%}
                                                <a href="/admin/article/index?pid={{pid}}&cate_id={{cate_id}}&group_id={{group_id}}&sortid={{sortid}}&sortval={{v.id|sort_url(val.option.identifier,typevar,nsobj)}}" class="text-primary" style="margin-right: 10px">{{v.name}}{{val.option.unit}}</a>
                                            {%endif%}
                                        {%endfor%}

                                        <!--子栏目-->
                                        {%for v in val.rules %}
                                            {%if v.id|sort_act(nsobj[val.option.identifier])%}
                                                {% if v.children%}
                                                    <div class="subtsm">

                                                        {% for v_ in v.children %}
                                                            {%if v_.id|sort_act(nsobj[val.option.identifier])%}
                                                                <span style="margin-right: 10px">{{v_.name}}{{val.option.unit}}</span>
                                                            {%else%}
                                                                <a href="/admin/article/index?pid={{pid}}&cate_id={{cate_id}}&group_id={{group_id}}&sortid={{sortid}}&sortval={{v_.id|sort_url(val.option.identifier,typevar,nsobj)}}" class="text-primary" style="margin-right: 10px">{{v_.name}}{{val.option.unit}}</a>
                                                            {%endif%}
                                                        {% endfor %}
                                                    </div>
                                                {%endif%}
                                            {%endif%}
                                        {%endfor%}
                                        <!--子栏目-->
                                        {%for v in val.rules %}
                                            {%if v.id|sort_act(nsobj[val.option.identifier])%}
                                                {% if v.children%}

                                                    {% for v_ in v.children %}
                                                        {%if v_.id|sort_act(nsobj[val.option.identifier])%}
                                                            {% if v_.children%}
                                                                <div class="subtsm">
                                                                    {% for v__ in v_.children %}

                                                                        {%if v__.id|sort_act(nsobj[val.option.identifier])%}

                                                                            <span style="margin-right: 10px">{{v__.name}}{{val.option.unit}}</span>
                                                                        {%else%}
                                                                            <a href="/admin/article/index?pid={{pid}}&cate_id={{cate_id}}&group_id={{group_id}}&sortid={{sortid}}&sortval={{v__.id|sort_url(val.option.identifier,typevar,nsobj)}}" class="text-primary" style="margin-right: 10px">{{v__.name}}{{val.option.unit}}</a>

                                                                        {%endif%}
                                                                    {%endfor%}
                                                                </div>
                                                            {%endif%}
                                                        {%endif%}
                                                    {% endfor %}

                                                {%endif%}
                                            {%endif%}
                                        {%endfor%}
                                    </td>

                                </tr>
                            {%endif%}
                        {%endfor%}

                        </tbody>
                    </table>
                </div>
            </div>


        {% endif %}

        <div class="panel-toolbar panel-toolbar-inbox panel-body" style="padding-left: 0;">

            <div class="navbar navbar-default">
                <ul class="nav navbar-nav visible-xs-block no-border">
                    <li>
                        <a class="text-center collapsed" data-toggle="collapse"
                           data-target="#inbox-toolbar-toggle-multiple">
                            <i class="icon-circle-down2"></i>
                        </a>
                    </li>
                </ul>

                <div class="navbar-collapse collapse" id="inbox-toolbar-toggle-multiple">

                    <div class="btn-group navbar-btn">

                        <a class="btn btn-default ajax-post confirm"
                           href="/admin/article/setstatus?status=-1"
                           target-form="ids">
                            <i class="icon-bin position-left"></i>
                            删除
                        </a>

                    </div>
                    <div class="navbar-right">
                        <div class="btn-group navbar-btn ">
                            <form class="heading-form">
                                <div class="input-group pull-right search-form">
                                    <input type="text" class="input-sm form-control"
                                           name="{{ model.search_key|default('title', true) }}"
                                           placeholder="请输入关键字"
                                           value="{{ controller.get('title') }}">
                                    <span class="input-group-btn">
                                        <button class="btn btn-sm btn-default" type="button" id="search"
                                                url="/admin/article/index?pid={{ pid }}{% if cate_id >0 %}&cate_id={{ cate_id }}{% endif %}">搜索  <i
                                                    class="position-right icon-search4"></i></button>
                                        </button>
                                    </span>
                                </div>

                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">

            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th style="width:20px;">
                        <input type="checkbox">
                    </th>
                    {% for field in list_grids %}
                        <th style="">{{ field.title }}</th>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                {% for data in list %}
                    <tr>
                        <td>
                            <input class="ids" type="checkbox" name="ids" value="{{ data.id }}">
                        </td>
                        {% for grid in list_grids %}
                            <td>{{ data|get_list_field(grid,ctx.controller) | safe }}</td>
                        {% endfor %}
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="{{ list_grids|length + 1 }}">
                            <div class="alert alert-warning alert-block">
                                <button data-dismiss="alert" class="close" type="button">×</button>
                                <p>
                                    还没有实验内容。
                                </p>
                            </div>
                        </td>
                    </tr>

                {% endfor %}

                </tbody>
            </table>
        </div>

        {% if pagerData %}
            <div class="panel-footer">
                <div class="col-md-12 text-right text-center-xs">
                    {{ pagerData | safe }}
                </div>
            </div>
        {% endif %}
    </div>
    <!-- /simple panel -->



{% endblock %}


{% block script %}
    <script src="/static/admin/js/zTree/jquery.ztree.core-3.5.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      <!--
      var zTree;
      var demoIframe;

      var setting = {
        async: {
          enable: true,
          url: "/admin/article/getmenu",
        },
        view: {
          showLine: true,
          selectedMulti: false,
        },
        callback: {
          onAsyncSuccess: zTreeOnAsyncSuccess

        }
      };

      function zTreeOnAsyncSuccess (event, treeId, treeNode, msg) {
        // console.log(treeNode)
        var treeObj = $.fn.zTree.getZTreeObj(treeId);
        treeObj.expandAll(true);
        var id = $("#" + treeId).attr("data-cate");
        curMenu = treeObj.getNodeByParam("id", id, null);
        treeObj.selectNode(curMenu);
      };

      function expandNode (e) {
        var zTree = $.fn.zTree.getZTreeObj("tree"),
          type = e.data.type,
          nodes = zTree.getSelectedNodes();
        if (type === "expandAll") {
          zTree.expandAll(true);
        } else if (type === "collapseAll") {
          zTree.expandAll(false);
        }
      }


      //-->
      $(function () {
        var t = $("#tree");
        t = $.fn.zTree.init(t, setting).expandAll(true);
        $("#expandAllBtn").bind("click", {type: "expandAll"}, expandNode);
        $("#collapseAllBtn").bind("click", {type: "collapseAll"}, expandNode);
        //搜索功能
        $("#search").click(function () {
          var url = $(this).attr('url');
          var query = $('.search-form').find('input').serialize();
          query = query.replace(/(&|^)(\w*?\d*?\-*?_*?)*?=?((?=&)|(?=$))/g, '');
          query = query.replace(/^&/g, '');
          if (url.indexOf('?') > 0) {
            url += '&' + query;
          } else {
            url += '?' + query;
          }
          window.location.href = url;
        });

        //回车自动提交
        $('.search-form').find('input').keyup(function (event) {
          if (event.keyCode === 13) {
            $("#search").click();
          }
        });

        //只有一个模型时，点击新增
        $('.document_add').click(function () {
          var url = $(this).attr('url');
          if (url !== undefined && url !== '') {
            window.location.href = url;
          }
        });
        if (localStorage.getItem("sortoggle") === 1) {
          $("#sorttoggle").addClass("active");
          $("#sortbody").removeClass("collapse");
        }
        //分类菜单
        $("#sorttoggle").click(function () {
          if (!$(this).is(".active")) {
            localStorage.setItem("sortoggle", 1)
          } else {
            localStorage.removeItem("sortoggle");
          }
        })
      })

    </script>
{% endblock %}

