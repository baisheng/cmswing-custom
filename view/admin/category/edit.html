{% extends "../inc/category/base.html" %}
{% block style %}
    <!--<link rel="stylesheet" href="/static/js/slider/slider.css" type="text/css" />-->
    <script src="/static/admin/js/jquery.min.js"></script>
    <link rel="stylesheet" href="/static/admin/js/webuploader/webuploader.css" type="text/css">
    <script src="/static/admin/js/webuploader/webuploader.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/static/admin/js/chosen/chosen.css" type="text/css"/>
{% endblock %}
{% block content %}
    <div class="panel panel-default">
        <div class="panel-body">
            <form action="{{ controller.action }}" class="form-horizontal" method="post" data-validate="parsley">
                <div class="tab-content">

                    <div id="tab1" class="tab-pane fade active in">
{#                        <div class="form-group">
                            <label class="col-sm-2 control-label"><i class="fa fa-asterisk text-danger"></i>
                                上级栏目</label>
                            <div class="col-sm-10">
                                <div class="row">
                                    <div class="col-md-3">
                                        <select class="form-control" name="pid" id="pid" data-pid="{{ info.pid }}">
                                        </select>
                                    </div>
                                    <div class="col-md-12 hide">
                                        <span class="help-block m-b-none text-muted"><i
                                                    class="fa fa-info-circle text-info"></i> 上级分类.</span>
                                    </div>
                                </div>
                            </div>
                        </div>#}
                        <div class="line line-dashed b-b line-lg pull-in"></div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label"><i class="fa fa-asterisk text-danger"></i>
                                栏目名称</label>
                            <div class="col-sm-10">
                                <div class="row">
                                    <div class="col-md-3"><input name="title" type="text" class="form-control"
                                                                 value="{{ info.title }}" data-required="true"></div>
                                    <div class="col-md-12 hide">
                                        <span class="help-block m-b-none text-muted"><i
                                                    class="fa fa-info-circle text-info"></i> 名称不能为空.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="line line-dashed b-b line-lg pull-in"></div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">栏目标识</label>
                            <div class="col-sm-10">
                                <div class="row">
                                    <div class="col-md-3"><input name="name" type="text" value="{{ info.name }}"
                                                                 class="form-control"></div>
                                    <div class="col-md-12">
                                        <span class="help-block m-b-none text-muted"><i
                                                    class="fa fa-info-circle text-info"></i> 非必填，填写后，此名称会替换url中的栏目id,英文字母.不能重复。</span>
                                    </div>
                                </div>
                            </div>
                        </div>

{#                        <div class="form-group">
                            <label class="col-sm-2 control-label">栏目图标</label>
                            <div class="col-sm-10">
                                <div class="row">
                                    <div class="col-sm-10">
                                        {{HOOKS@adminUpPic.icon|safe}}
                                    </div>
                                    <div class="col-md-12 hide">
                                        <span class="help-block m-b-none text-muted"><i
                                                    class="fa fa-info-circle text-info"></i> 图片上传</span>
                                    </div>
                                </div>


                            </div>
                        </div>#}
                        <div class="form-group">
                            <label class="col-sm-2 control-label">排序</label>
                            <div class="col-sm-10">
                                <div class="row">
                                    <div class="col-md-2"><input name="sort" value="{{info.sort}}" type="text"
                                                                 class="form-control"></div>
                                    <div class="col-md-12">
                                        <span class="help-block m-b-none text-muted"><i
                                                    class="fa fa-info-circle text-info"></i> 仅对当前层级分类有效</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="line line-dashed b-b line-lg pull-in"></div>
                    </div>

                    {#{% if mod.type_show ==1 %}#}
                        <input type="hidden" name="documentsorts" value="{{ info.documentsorts }}">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">启用分类信息</label>
                            <div class="col-sm-10">
                                <div class="row">
                                    <div class="col-md-10">
                                        <label class="radio-inline i-checks">
                                            <input type="radio" value="1" name="documentsorts[status]"
                                                   {% if info.documentsorts !="" %}checked=""{% endif %}><i></i> 是
                                        </label>
                                        <label class="radio-inline i-checks">
                                            <input type="radio" value="0" name="documentsorts[status]"
                                                   {% if info.documentsorts =="" %}checked=""{% endif %}><i></i> 否
                                        </label>

                                    </div>
                                    <div class="col-md-12">
                                        <span class="help-block m-b-none text-muted"><i
                                                    class="fa fa-info-circle text-info"></i> 以下设置没有继承性，即仅对当前栏目有效，不会对下级子栏目产生影响。</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="line line-dashed b-b line-lg pull-in"></div>
                        {% set types = info.documentsorts|strToJson %}
                        <div id="documentsortscon" {% if info.documentsorts =="" %}style="display:none;"
                             {% else %}style="display:block;"{% endif %}>
{#                            <div class="form-group">
                                <label class="col-sm-2 control-label">发布必须归类</label>
                                <div class="col-sm-10">
                                    <div class="row">
                                        <div class="col-md-10"><label class="radio-inline i-checks">
                                                <input type="radio" value="1" name="documentsorts[required]"
                                                       {% if types.required == 1 %}checked=""{% endif %}><i></i> 是
                                            </label>
                                            <label class="radio-inline i-checks">
                                                <input type="radio" value="0" name="documentsorts[required]"
                                                       {% if types.required == 0 %}checked=""{% endif %}><i></i> 否
                                            </label></div>
                                        <div class="col-md-12">
                                            <span class="help-block m-b-none text-muted"><i
                                                        class="fa fa-info-circle text-info"></i> 是否强制用户发表新内容时必须选择分类</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="line line-dashed b-b line-lg pull-in"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">类别前缀</label>
                                <div class="col-sm-10">
                                    <div class="row">
                                        <div class="col-md-10"><label class="radio-inline i-checks">
                                                <input type="radio" value="1" name="documentsorts[prefix]"
                                                       {% if types.prefix == 1 %}checked=""{% endif %}><i></i> 是
                                            </label>
                                            <label class="radio-inline i-checks">
                                                <input type="radio" value="0" name="documentsorts[prefix]"
                                                       {% if types.prefix == 0 %}checked=""{% endif %}><i></i> 否
                                            </label></div>
                                        <div class="col-md-12">
                                            <span class="help-block m-b-none text-muted"><i
                                                        class="fa fa-info-circle text-info"></i> 是否在主题前面显示分类的名称</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="line line-dashed b-b line-lg pull-in"></div>

                            <div class="line line-dashed b-b line-lg pull-in"></div>#}
                            <div class="form-group">
                                <label class="col-sm-2 control-label">启用默认显示分类</label>
                                <div class="col-sm-10">
                                    <div class="row">
                                        <div class="col-md-10"><label class="radio-inline i-checks">
                                                <input type="radio" value="1" name="documentsorts[default]"
                                                       {% if types.default == 1 %}checked=""{% endif %}><i></i> 是
                                            </label>
                                            <label class="radio-inline i-checks">
                                                <input type="radio" value="0" name="documentsorts[default]"
                                                       {% if types.default == 0 %}checked=""{% endif %}><i></i> 否
                                            </label></div>
                                        <div class="col-md-12">
                                            <span class="help-block m-b-none text-muted"><i
                                                        class="fa fa-info-circle text-info"></i> 是否启用默认显示分类，如果启用请在下面的分类信息里面选择</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">选择分类</label>
                                <div class="col-sm-10">
                                    <div class="row">
                                        <div class="col-md-10">
                                            <table class="table table-striped m-b-none" id="typelist">
                                                <thead>
                                                <tr>
                                                    <th style="width: 70px;">启用</th>
                                                    <th>分类名称</th>
                                                    <th>分类说明</th>
                                                    <th style="width: 150px;">发布菜单中显示</th>
                                                    <th style="width: 150px;">默认显示分类</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for val in typelist %}
                                                    <tr>
                                                        <td>
                                                            <label class="checkbox i-checks"
                                                                   style="padding-top: 0;"><input type="checkbox"
                                                                                                  name="documentsorts[options][enable]"
                                                                                                  value="{{ val.typeid }}"
                                                                                                  class="enable" {% if typeobj[val.typeid].enable %} checked {% endif %}><i></i></label>
                                                        </td>
                                                        <td>{{ val.name }}</td>
                                                        <td>{{ val.description }}</td>
                                                        <td class="text-success">
                                                            <label class="checkbox i-checks"
                                                                   style="padding-top: 0;"><input type="checkbox"
                                                                                                  name="documentsorts[options][show]"
                                                                                                  value="1"
                                                                                                  class="show" {% if typeobj[val.typeid].show %} checked {% endif %}><i></i></label>
                                                        </td>
                                                        <td class="text-success">
                                                            <label class="checkbox i-checks"
                                                                   style="padding-top: 0;"><input type="radio"
                                                                                                  name="documentsorts[defaultshow]"
                                                                                                  value="{{ val.typeid }}"
                                                                                                  class="defaultshow" {% if types.defaultshow == val.typeid %} checked {% endif %}><i></i></label>
                                                        </td>

                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="col-md-12">
                                            <span class="help-block m-b-none text-muted"><i
                                                        class="fa fa-info-circle text-info"></i> 关键字</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="line line-dashed b-b line-lg pull-in"></div>
                        </div>
                    {#{% endif %}#}
                </div>
                <div class="form-group form-submit">
                    <div class="col-sm-4 col-sm-offset-2">
                        <input type="hidden" name="id" value="{{ info.id|default('',true) }}">
                        <button type="submit" target-form="form-horizontal" class="btn btn-primary ajax-post">保存
                        </button>
                        <button type="submit" class="btn btn-default"
                                onclick="javascript:history.back(-1);return false;">返回
                        </button>
                    </div>
                </div>
            </form>

        </div>
    </div>
{% endblock %}

{% block script %}
    <!-- slider -->
    <!--<script src="/static/js/slider/bootstrap-slider.js"></script>-->
    <!-- file input -->
    <script src="/static/admin/js/file-input/bootstrap-filestyle.min.js"></script>
    <script src="/static/admin/js/parsley/parsley.min.js"></script>
    <script src="/static/admin/js/parsley/parsley.extend.js"></script>
    <script src="/static/admin/js/chosen/chosen.jquery.min.js"></script>
    <script type="text/javascript">
      $(function () {

        //获取上级菜单
        $.ajax({
          url: "/admin/category/gettree",
          data: {cid:{{ controller.get('cid') }}},
          success: function (msg) {
            /* 展示生成的HTML */
            $("#pid").html(category_to_html(msg));

          }
        })

        //添加
        function addtype () {
          var required = $('input[name="documentsorts[required]"]:checked').val() || 0;
          var prefix = $('input[name="documentsorts[prefix]"]:checked').val() || 0;
          var defaults = $('input[name="documentsorts[default]"]:checked').val() || 0;
          var defaultshow = $('input[name="documentsorts[defaultshow]"]:checked').val() || 0;
          var types = []
          $("#typelist>tbody>tr").each(function (k, v) {
            var obj = {}
            obj.enable = $(v).find("input[name='documentsorts[options][enable]']:checked").val() || 0;
            obj.name = $(v).find("td").eq(1).text();
            obj.description = $(v).find("td").eq(2).text();
            obj.show = $(v).find("input[name='documentsorts[options][show]']:checked").val() || 0;
            if (obj.enable != 0) {
              types.push(obj);
            }
          });
          var documentsorts = {
            required: required,
            prefix: prefix,
            default: defaults,
            defaultshow: defaultshow,
            types: types
          }
          $('input[name="documentsorts"]').val("");
          $('input[name="documentsorts"]').val(JSON.stringify(documentsorts));
        }

        $('.enable,.show,.defaultshow,[name="documentsorts[required]"],[name="documentsorts[prefix]"],[name="documentsorts[default]"]').on('change', function () {
          addtype()
        })

        $('input[name="documentsorts[status]"]').click(function () {
          var val = $(this).val();
          if (val == 1) {
            $("#documentsortscon").show();
            addtype();
          } else {
            $("#documentsortscon").hide();
            $('input[name="documentsorts"]').val("");
          }
        })

        /* 生成HTML ul/li 形式 */
        function category_to_html (nodes) {
          var html = [];
          var size = nodes.length;
          var left = null;
          var pid = "{{ info.pid }}";
          var check = "";
          if (pid == 0) {
            html.push('<option value="0" selected="selected">一级菜单</option>');
          } else {
            html.push('<option value="0" >一级菜单</option>');
          }
          for (var i = 0; i < size; i++) {
            left = nodes[i];
            if (pid == left.id) {
              html.push('<option value="' + left['id'] + '" selected="selected">' + new Array(left["deep"] + 1).join("= ") + left['title'] + '</option>');
            } else {
              html.push('<option value="' + left['id'] + '">' + new Array(left["deep"] + 1).join("= ") + left['title'] + '</option>');
            }
            //console.log(left.id);

          }
          return html.join("\n");
        }

        $(".addtemp").click(function () {
          var href = $(this).attr("id");
          var id = "#" + href.split("_")[0];
          var url = $(id).find(".addtemp").attr("data-url");
          window.location.href = url;
        })
      })
    </script>
{% endblock %}